<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Objective 2 - Write Custom Middleware</title>
<meta name="identifier" content="g032a0f44f919d6ca7d58395a04d65c9b"/>
<meta name="editing_roles" content="teachers"/>
<meta name="workflow_state" content="active"/>
</head>
<body>
<p>&nbsp;</p>
<p><iframe class="wistia_embed" title="Custom Middleware Video" src="https://fast.wistia.net/embed/iframe/zc6ucko8r6" width="640" height="360" name="wistia_embed" allow="autoplay; fullscreen" loading="lazy"></iframe></p>
<p>&nbsp;</p>
<h2 id="overview">Overview</h2>
<p>Writing <strong>custom middleware</strong> is a two-step process:</p>
<ol>
<li aria-level="1"><span>Write a function that will receive three or four arguments.</span></li>
<li>Add it to the <em>middleware queue</em>.</li>
</ol>
<p><span>Let's tackle the first part with an example. We'll write middleware that logs information about every request that comes into our server. We'll be displaying the information in the console window to keep things simple.</span></p>
<pre style="background-image: none; background-attachment: scroll; background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal; font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px; background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none; background-attachment: scroll; background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal; font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;"><span style="border: 0px none #d73a49; color: #d73a49;">function</span> <span style="border: 0px none #6f42c1; color: #6f42c1;">logger</span>(<span>req, res, next</span>) {<br>&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">console</span>.<span style="border: 0px none #6f42c1; color: #6f42c1;">log</span>(<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #032f62; color: #032f62;">`[<span style="border: 0px none #24292e; color: #24292e;">${<span style="border: 0px none #d73a49; color: #d73a49;">new</span> <span style="border: 0px none #e36209; color: #e36209;">Date</span>().toISOString()}</span>] <span style="border: 0px none #24292e; color: #24292e;">${req.method}</span> to <span style="border: 0px none #24292e; color: #24292e;">${req.url}</span> from <span style="border: 0px none #24292e; color: #24292e;">${req.get(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #032f62; color: #032f62;">'Origin'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;)}</span>`</span><br>&nbsp;&nbsp;);<br><br>&nbsp;&nbsp;<span style="border: 0px none #6f42c1; color: #6f42c1;">next</span>();<br>}</code></pre>
<p>We can see that a middleware function takes <strong>three parameters</strong>:</p>
<ol>
<li>the <code>request</code> object</li>
<li>the <code>response</code> object</li>
<li>a <code>function that points to the next middleware</code> in the queue</li>
</ol>
<p>By convention, we name the third parameter <code>next</code>. Please stick to that convention in your code.</p>
<p><span>Any middleware in the queue CAN modify both the request and response objects, but it's NOT required. So, in this case, we are not making changes to either.</span></p>
<p><span>Any middleware in the queue can stop the request and send a response back to the client. When that happens, the rest of the middleware, including the route handlers, will not work. We'll see an example of this in the code-along section.</span></p>
<p>Calling the <code>next()</code> function signals to Express that the middleware has finished, and it should call the next middleware function. <strong>If <code>next()</code> is not called and a response is not sent back to the client, the request will hang, and clients will get a timeout error.</strong> So, make sure always to call <code>next()</code> or use one of the methods that send a response back like <code>res.send()</code> or <code>res.json()</code>.</p>
<p>Now let's add our shiny middleware to the queue! Right after <code>server.use(express.json());</code> add the following line.</p>
<pre style="background-image: none;  background-attachment: scroll;   background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal;   font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px;      background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none;  background-attachment: scroll;   background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal;   font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;">server.<span style="border: 0px none #6f42c1; color: #6f42c1;">use</span>(logger);</code></pre>
<p><span>Hitting any of our endpoints will display some information about the request in the console.</span></p>
<p><span>Congratulations, you know how to write custom middleware for Express!</span></p>
<h2 id="follow-along">Follow Along</h2>
<p><span>Any middleware in the queue can stop the request and send a response back to the client. The rest of the middleware, including the route handlers, will not be executed when that happens. Let's see this in action by writing our very own authentication middleware, but first, a bit of a story (any similarity to an actual story is a pure coincidence).</span></p>
<p><span>Imagine you're next to a lake where a dangerous creature dwells, and it is moving towards you with ill intentions. Luckily, next to you is a sealed door that leads to safety. But, unfortunately, to open the door, you need to provide the right password. So let's implement the API for that.</span></p>
<p><span>Start by defining a function that shows our current predicament at the console as the application loads.</span></p>
<pre style="background-image: none; background-attachment: scroll; background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal; font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px; background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none; background-attachment: scroll; background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal; font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;"><span style="border: 0px none #d73a49; color: #d73a49;">function</span> <span style="border: 0px none #6f42c1; color: #6f42c1;">atGate</span>(<span>req, res, next</span>) {<br>&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">console</span>.<span style="border: 0px none #6f42c1; color: #6f42c1;">log</span>(<span style="border: 0px none #032f62; color: #032f62;">'At the gate, about to be eaten`);<br><br>&nbsp;&nbsp;next();<br>}</span></code></pre>
<p>Then add it as the first middleware in the queue.</p>
<pre style="background-image: none;  background-attachment: scroll;   background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal;   font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px;      background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none;  background-attachment: scroll;   background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal;   font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;">server.<span style="border: 0px none #6f42c1; color: #6f42c1;">use</span>(atGate);</code></pre>
<p><span>This middleware is what's called global or application-wide middleware. It applies to every endpoint in our server. Therefore, accessing any route in our server should display the message on the console.</span></p>
<p><span>Now let's add the authentication middleware that only grants access if we hit the correct route; picking any other route is futile, so be careful!</span></p>
<pre style="background-image: none; background-attachment: scroll; background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal; font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px; background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none; background-attachment: scroll; background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal; font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;"><span style="border: 0px none #d73a49; color: #d73a49;">function</span> <span style="border: 0px none #6f42c1; color: #6f42c1;">auth</span>(<span>req, res, next</span>) {<br>&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">if</span> (req.<span>url</span> === <span style="border: 0px none #032f62; color: #032f62;">'/mellon'</span>) {<br>&nbsp;&nbsp;&nbsp;&nbsp;<span style="border: 0px none #6f42c1; color: #6f42c1;">next</span>();<br>&nbsp;&nbsp;} <span style="border: 0px none #d73a49; color: #d73a49;">else</span> {<br>&nbsp;&nbsp;&nbsp;&nbsp;res.<span style="border: 0px none #6f42c1; color: #6f42c1;">send</span>(<span style="border: 0px none #032f62; color: #032f62;">'You shall not pass!'</span>);<br>&nbsp;&nbsp;}<br>}</code></pre>
<p>Now let's add a route handler that leads to safety:</p>
<pre style="background-image: none; background-attachment: scroll; background-color: #ffffff; border: 1px solid #c7cdd1; clear: none; color: #24292e; cursor: auto; direction: ltr; font-style: normal; font-stretch: normal; font-size: 12px; line-height: 14.4px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px 0px 12px; padding: 9px; text-align: start; text-decoration: none; text-indent: 0px; white-space: pre-wrap; border-collapse: separate; border-spacing: 0px; background-position: 0% 0%; background-repeat: repeat repeat;" data-hljs-language="javascript"><code style="background-image: none; background-attachment: scroll; background-color: rgba(0, 0, 0, 0); border: 0px none #24292e; font-style: normal; font-stretch: normal; font-size: 16px; line-height: 19.200001px; font-family: Monaco, Menlo, Consolas, 'Courier New', monospace; margin: 0px; padding: 0px; background-position: 0% 0%; background-repeat: repeat repeat;">server.<span style="border: 0px none #6f42c1; color: #6f42c1;">get</span>(<span style="border: 0px none #032f62; color: #032f62;">'/mellon'</span>, auth, <span>(<span>req, res</span>) =&gt;</span> {<br>&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">console</span>.<span style="border: 0px none #6f42c1; color: #6f42c1;">log</span>(<span style="border: 0px none #032f62; color: #032f62;">'Gate opening...'</span>);<br>&nbsp;&nbsp;<span style="border: 0px none #d73a49; color: #d73a49;">console</span>.<span style="border: 0px none #6f42c1; color: #6f42c1;">log</span>(<span style="border: 0px none #032f62; color: #032f62;">'Inside and safe'</span>);<br>&nbsp;&nbsp;res.<span style="border: 0px none #6f42c1; color: #6f42c1;">send</span>(<span style="border: 0px none #032f62; color: #032f62;">'Welcome Traveler!'</span>);<br>});</code></pre>
<p><span>What's new here is that we are adding our middleware as the second parameter and the route handler as the third. Using middleware this way is what we call <strong>local middleware</strong> or route middleware. It just means we are using middleware locally and only applies to the endpoint where it's added.</span></p>
<h2 id="challenge">Challenge</h2>
<p><span>Write a piece of middleware that responds with the message, "Balance is the key; making things even is the secret to success." In addition, it should send an HTTP Status Code 403 (Forbidden) when the client sends a request when the seconds' value in the server clock is odd. Otherwise, let the request flow through the rest of the middleware queue.</span></p>
<p><span>For example, if a client makes any request and the server clock is at 11:10:11 or 11:10:13, the request is rejected. But, at 11:10:12 or 11:10:14, the request is accepted and handled.</span></p>
</body>
</html>